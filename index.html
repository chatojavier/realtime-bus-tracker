<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Real Time Bus Tracker</title>
<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
  
<div id="map"></div>
 
<script>

	//Mapbox token
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2hhdG9qYXZpZXIiLCJhIjoiY2twcnFxb3JtMHEzOTJwbGVseXNtZXI5cCJ9.xszgx99NJUKZEtQFthMWVA';

	//create the map
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-71.091542,42.358862],
        zoom: 12
    });

	counter = 0;

	// Function that change the positions of buses
	async function run(){
		// get bus data    
		if(counter !== 0) {
			markers.forEach(marker => {
				marker.remove();
			});
		}

		const locations = await getBusLocations();
		console.log(new Date());
		console.log(locations);

		markers = [];
		locations.forEach(bus => {
			//latitude and longitude data
			const lat = bus.attributes.latitude;
			const lng = bus.attributes.longitude;

			//create the popup
			var popup = new mapboxgl.Popup({ offset: 25 })
			.setHTML(
			`<div>Bus ID: ${bus.attributes.label} </div>
			<div>Occupancy: ${bus.attributes.occupancy_status}</div>`
			);
			console.log(popup)

			//Maker bus image
			const busMarker = document.createElement('img');
			busMarker.src = './blue.png';

			// create the marker
			var marker = new mapboxgl.Marker({
				element: busMarker,
			})
			.setLngLat([lng, lat])
			.setPopup(popup)
			.addTo(map);
			markers.push(marker);
		});

		// timer
		counter++;
		setTimeout(run, 15000);
	}

	// Request bus data from MBTA
	async function getBusLocations(){
		const url = 'https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip';
		const response = await fetch(url);
		const json     = await response.json();
		return json.data;
	}

	run();

</script>
 
</body>
</html>